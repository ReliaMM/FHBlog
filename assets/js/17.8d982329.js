(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{275:function(t,a,s){"use strict";s.r(a);var e=s(19),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"gitlab-ci-cd-自动部署构建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-cd-自动部署构建"}},[t._v("#")]),t._v(" GitLab CI/CD 自动部署构建")]),t._v(" "),s("h2",{attrs:{id:"一、背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、背景"}},[t._v("#")]),t._v(" 一、背景")]),t._v(" "),s("p",[t._v("每次改完需求之后，更新到测试服务器都需要"),s("strong",[t._v("手动")]),t._v("打包，并"),s("strong",[t._v("上传")]),t._v("到服务器，多次人工干预操作，目前就有这样一个现成的基于 "),s("code",[t._v("GitLab CI")]),t._v(" 工具，让我们"),s("strong",[t._v("提交")]),t._v("或者"),s("strong",[t._v("合并")]),t._v("代码后，就自动帮我们执行一段任务(打包、压缩、上传服务器)。从而实现自动上线。这里记录一下简单的步骤，因为每个人安装会面对不同的问题，后期有值得总结的，再补充。")]),t._v(" "),s("h2",{attrs:{id:"二、git-runner-介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、git-runner-介绍"}},[t._v("#")]),t._v(" 二、Git Runner 介绍")]),t._v(" "),s("h3",{attrs:{id:"是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#是什么"}},[t._v("#")]),t._v(" 是什么")]),t._v(" "),s("p",[t._v("它是我们自动构建的主服务")]),t._v(" "),s("blockquote",[s("p",[t._v("Runner 是一个执行任务的进程。可以根据需要配置任意数量的 Runner。\nRunner 可以放在"),s("strong",[t._v("不同的用户")]),t._v("、"),s("strong",[t._v("服务器")]),t._v("，甚至 "),s("strong",[t._v("本地机器上。")])])]),t._v(" "),s("h3",{attrs:{id:"怎么配"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#怎么配"}},[t._v("#")]),t._v(" 怎么配")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1584626140254-5e365765-184f-4571-8c0c-abf4738c98c9.png#align=left&display=inline&height=69&name=image.png&originHeight=236&originWidth=2540&size=44889&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("p",[t._v("它实际就是 "),s("code",[t._v(".gitlab-ci.yml")]),t._v(" ，写一下然后交给 "),s("code",[t._v("Git Runner")]),t._v("  去执行。\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1584626168105-aa400b69-f9b8-4dc6-bfde-08e79d29efe6.png#align=left&display=inline&height=135&name=image.png&originHeight=270&originWidth=2146&size=40317&status=done&style=none&width=1073",alt:"image.png"}})]),t._v(" "),s("h3",{attrs:{id:"怎么安装-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#怎么安装-runner"}},[t._v("#")]),t._v(" 怎么安装 Runner")]),t._v(" "),s("h4",{attrs:{id:"先安装-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#先安装-docker"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://www.yuque.com/mty/here/vrqiwx#BPan3",target:"_blank",rel:"noopener noreferrer"}},[t._v("先安装 Docker"),s("OutboundLink")],1)]),t._v(" "),s("h4",{attrs:{id:"强调的是配置阿里云服务器-docker-源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#强调的是配置阿里云服务器-docker-源"}},[t._v("#")]),t._v(" 强调的是配置阿里云服务器 Docker 源")]),t._v(" "),s("ul",[s("li",[t._v("购买阿里云服务器会默认给你分配一个 "),s("a",{attrs:{href:"https://cr.console.aliyun.com/cn-shenzhen/instances/mirrors",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker 源"),s("OutboundLink")],1),t._v("，这样拽 Docker 镜像会比较快。")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /etc/docker\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /etc/docker/daemon.json "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\n{\n  "registry-mirrors": ["https://[你的私有key].mirror.aliyuncs.com"]\n}\nEOF')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl daemon-reload\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl restart docker\n")])])]),s("h2",{attrs:{id:"三、安装配置-git-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、安装配置-git-runner"}},[t._v("#")]),t._v(" 三、安装配置 Git Runner")]),t._v(" "),s("h4",{attrs:{id:"_1、拉取-gitlab-runner-镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、拉取-gitlab-runner-镜像"}},[t._v("#")]),t._v(" 1、拉取 gitlab-runner 镜像")]),t._v(" "),s("blockquote",[s("p",[t._v("docker 镜像加速器配置好，这块会快一些，没配置的可能会慢一点")])]),t._v(" "),s("p",[s("code",[t._v("Git Runner")]),t._v("  它是辅助 "),s("code",[t._v("Git")]),t._v("  构建的一个服务")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("docker pull gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner\n")])])]),s("p",[t._v("安装好之后可以 "),s("code",[t._v("docker images")]),t._v("  测试查看\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1584627174924-869041e9-30f9-4d11-a6af-1afbc462f0ac.png#align=left&display=inline&height=97&name=image.png&originHeight=212&originWidth=1632&size=61457&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"_2、创建容器并启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、创建容器并启动"}},[t._v("#")]),t._v(" 2、创建容器并启动")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("docker run "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("name gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("restart always \\\n   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner \\\n   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("docker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock \\\n   gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("latest\n")])])]),s("p",[t._v("现在 "),s("code",[t._v("gitlab-runner")]),t._v("  就启动了，可以通过 "),s("code",[t._v("docker ps")]),t._v("  查看，\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1584627417736-f7cfa67e-5f1e-439a-871f-2496e411a697.png#align=left&display=inline&height=39&name=image.png&originHeight=122&originWidth=2352&size=36339&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"_3、注册-gitlab-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3、注册-gitlab-runner"}},[t._v("#")]),t._v(" 3、注册 gitlab-runner")]),t._v(" "),s("blockquote",[s("p",[t._v("这里容器ID是上一步执行的返回的 ID，只去前几位就行。不用复制完。")])]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("docker exec "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("it "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("容器"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ID")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("runner register\n")])])]),s("p",[t._v("上面命令执行中会让你一次让你输入 gitlab URL、token、runner-server、tag、docker、docker:stable")]),t._v(" "),s("h5",{attrs:{id:"_2-1、填写-gitlab-url"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、填写-gitlab-url"}},[t._v("#")]),t._v(" 2.1、填写 Gitlab URL")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("Please enter the gitlab-ci coordinator URL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e.g. https://gitlab.com/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n")])])]),s("h5",{attrs:{id:"_2-2、填写-token"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、填写-token"}},[t._v("#")]),t._v(" 2.2、填写 token")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("Please enter the gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ci token "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" runner"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n")])])]),s("h5",{attrs:{id:"_2-3、runner-描述信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、runner-描述信息"}},[t._v("#")]),t._v(" 2.3、runner 描述信息")]),t._v(" "),s("p",[t._v("这里起了 runner-server")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("Please enter the gitlab-ci description "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" this runner:\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ec66aa43edf6"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": runner-server\n")])])]),s("h5",{attrs:{id:"_2-4、填写-tag-名字"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4、填写-tag-名字"}},[t._v("#")]),t._v(" 2.4、填写 tag 名字")]),t._v(" "),s("p",[t._v("一个 git 仓库可以对应多个 runnder, 执行 yml 文件可以指定某一个 runner , 所以需要起一个名字标识")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("Please enter the gitlab"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ci tags "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("runner")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("comma separated"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n")])])]),s("h5",{attrs:{id:"_2-5、执行器选择-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5、执行器选择-docker"}},[t._v("#")]),t._v(" 2.5、执行器选择 docker")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("Please enter the executor: docker-ssh, parallels, virtualbox, docker-ssh+machine, custom, docker, shell, ssh, docker+machine, kubernetes:\ndocker\n")])])]),s("h5",{attrs:{id:"_2-6、docker-img"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-6、docker-img"}},[t._v("#")]),t._v(" 2.6、Docker img")]),t._v(" "),s("p",[t._v("这里输入 docker:stable")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("Please enter the "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" Docker "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("image")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("g"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" ruby"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\ndocker"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("stable\n")])])]),s("h4",{attrs:{id:"这几个值怎么找，登陆你的-gitlab-设置-ci-cd-runner-展开"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#这几个值怎么找，登陆你的-gitlab-设置-ci-cd-runner-展开"}},[t._v("#")]),t._v(" 这几个值怎么找，登陆你的 gitlab -> 设置 -> CI/CD -> Runner 展开")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583988761280-fdcd94ba-f4d1-4200-9145-948dc4b33ade.png#align=left&display=inline&height=224&name=image.png&originHeight=766&originWidth=2554&size=163356&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"找到-gitlab-url、token"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#找到-gitlab-url、token"}},[t._v("#")]),t._v(" 找到 gitlab URL、token")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583988840033-aedd8145-751e-4462-b2d7-e3a7a98563dd.png#align=left&display=inline&height=428&name=image.png&originHeight=1334&originWidth=2324&size=319785&status=done&style=shadow&width=746",alt:"image.png"}}),t._v(" "),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583989584410-43e8baf5-c4f4-415f-b09d-9657afc51996.png#align=left&display=inline&height=233&name=image.png&originHeight=466&originWidth=1480&size=167092&status=done&style=shadow&width=740",alt:"image.png"}}),t._v("\n到这里 "),s("code",[t._v("runner")]),t._v("  配置成功\n配置成功之后，将会在页面中看到 此项目已激活的运行器\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1584628201217-fbe8ac69-74bf-4c05-8db1-da7a0df193ab.png#align=left&display=inline&height=297&name=image.png&originHeight=594&originWidth=1406&size=67642&status=done&style=shadow&width=703",alt:"image.png"}})]),t._v(" "),s("h2",{attrs:{id:"四、yml-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、yml-配置"}},[t._v("#")]),t._v(" 四、yml 配置")]),t._v(" "),s("p",[t._v("我们需要创建一个 "),s("code",[t._v(".gitlab-ci.yml")]),t._v("  文件，一下有一个例子")]),t._v(" "),s("h4",{attrs:{id:"例子"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[t._v("#")]),t._v(" 例子")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用哪个镜像构建")]),t._v("\nimage: node\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 阶段")]),t._v("\nstages:\n  - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n  - build\n  - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("zip")]),t._v("\n  - deploy\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 每一步骤都需要拉取新的镜像，cache 缓存做一个保留")]),t._v("\ncache:\n    paths:\n        - node_modules/\n        - dist/\n        - front-end-caiwu.tar\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行所有 script 之前都会执行的 script 钩子")]),t._v("\nbefore_script:\n  - "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y ) '")]),t._v("\n  - "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("eval")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("ssh-agent -s"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n  - ssh-add "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SSH_PRIVATE_KEY_DEV")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 因为在 node 镜像中执行，若是选择执行器 是 shell 此步会干掉宿主机的ssh")]),t._v("\n  - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p ~/.ssh\n  - "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[[ -f /.dockerenv ]] && echo -e \"Host *"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[t._v("\\t")]),t._v("StrictHostKeyChecking no"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("\" > ~/.ssh/config'")]),t._v("\n\n\ninstall:\n  stage: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n  tags:\n   - tagcicd\n  script:\n    - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -g cnpm --registry"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://registry.npm.taobao.org\n    - cnpm "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n\nbuild:\n  stage: build\n  script:\n    - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n\nzip:\n  stage: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("zip")]),t._v("\n  script:\n   - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -czvf front-end-caiwu.tar ./dist\n\ndeploy:\n  stage: deploy\n  script:\n   - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" ./front-end-caiwu.tar root@XXXXXXXX:/data\n\n")])])]),s("h4",{attrs:{id:"默认-tags"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#默认-tags"}},[t._v("#")]),t._v(" 默认 tags")]),t._v(" "),s("p",[t._v("上面 yml 配置没有指名 tags, 可配置一个默认的\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1584628246707-90e47224-5cf5-46a9-b11f-635fe40b5127.png#align=left&display=inline&height=201&name=image.png&originHeight=402&originWidth=662&size=24005&status=done&style=shadow&width=331",alt:"image.png"}}),t._v(" "),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583990271831-fb637bef-efc2-4e56-a2c1-741dd12bf8da.png#align=left&display=inline&height=340&name=image.png&originHeight=680&originWidth=1288&size=74584&status=done&style=shadow&width=644",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:""}},[s("a",{staticClass:"header-anchor",attrs:{href:"#"}},[t._v("#")])]),t._v(" "),s("h4",{attrs:{id:"变量配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#变量配置"}},[t._v("#")]),t._v(" 变量配置")]),t._v(" "),s("ul",[s("li",[t._v("需要注意  $SSH_PRIVATE_KEY_DEV 是变量，需要在下图中配置 值是 value 需要配置一下")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583989717836-6f3c2fb4-4055-4895-a09d-0702bc236a0f.png#align=left&display=inline&height=242&name=image.png&originHeight=772&originWidth=2384&size=176195&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"ssh-private-key-dev-value-生成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ssh-private-key-dev-value-生成"}},[t._v("#")]),t._v(" $SSH_PRIVATE_KEY_DEV value 生成")]),t._v(" "),s("p",[t._v("这一步很容易出现问题，网上版本也多，解决方案也不一样。一下可参考，但不保证按照步骤来就没问题。")]),t._v(" "),s("p",[t._v("1、首先，在任何一台服务器上称A，创建 RSA 无密码的密钥：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("ssh"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("keygen "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t rsa "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("P")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("\ncat "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ssh"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("id_rsa\n")])])]),s("p",[t._v("2、特别注意需要复制完整包含 --- 复制到上图中 value里面")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BEGIN")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RSA")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PRIVATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" \nxxxxxxx \n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("END")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("RSA")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PRIVATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("\n")])])]),s("p",[t._v("3、然后在 A 服务器，执行代码 ssh-copy-id root 你需要部署的服务器 B, 期间会让你输入一次密码，后期就不会在输入。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RSA 密钥对应的公钥，上传到需要连接到的服务器")]),t._v("\nssh-copy-id root@你的服务器地址\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 测试")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" root@你的服务器地址  \n")])])]),s("h2",{attrs:{id:"五、自动运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、自动运行"}},[t._v("#")]),t._v(" 五、自动运行")]),t._v(" "),s("p",[t._v("当你push 代码的时候，会自动生成一条流水线")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583990492665-0495ef89-aba3-4d6f-b6e6-35ddc8a11dce.png#align=left&display=inline&height=178&name=image.png&originHeight=586&originWidth=2462&size=122502&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("p",[t._v("感受一下\n"),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583990714253-a2dc3853-d245-41d6-9ca7-4137bb1f27ff.png#align=left&display=inline&height=502&name=image.png&originHeight=1458&originWidth=2166&size=345869&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"第二阶段-打包-build"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第二阶段-打包-build"}},[t._v("#")]),t._v(" 第二阶段 打包 build")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583990883678-b9464414-7fe9-4f46-9b9d-1e22ce74a1d4.png#align=left&display=inline&height=333&name=image.png&originHeight=886&originWidth=1986&size=81677&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"第三阶段-压缩称-zip"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第三阶段-压缩称-zip"}},[t._v("#")]),t._v(" 第三阶段 压缩称 zip")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583991079364-eedb6014-815c-4840-a9cf-5cf1f1b8ac84.png#align=left&display=inline&height=337&name=image.png&originHeight=868&originWidth=1924&size=79458&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("h4",{attrs:{id:"第四阶段-deploy-成功"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第四阶段-deploy-成功"}},[t._v("#")]),t._v(" 第四阶段 deploy 成功")]),t._v(" "),s("ul",[s("li",[t._v("好长时间 4个job 14分钟")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583991394653-5043793a-b57c-4fa2-9ff1-758118fe8e86.png#align=left&display=inline&height=414&name=image.png&originHeight=828&originWidth=2058&size=81638&status=done&style=none&width=1029",alt:"image.png"}})]),t._v(" "),s("p",[t._v("成功 生成 front-end-caiwu.tar  可以在yml 命令添加 解压缩放置到对应后端指定目录中。")]),t._v(" "),s("h3",{attrs:{id:"-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[t._v("#")]),t._v(" "),s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583991482633-8639b152-922f-4249-82f4-8b2c5a13ffc3.png#align=left&display=inline&height=129&name=image.png&originHeight=258&originWidth=1126&size=49455&status=done&style=shadow&width=563",alt:"image.png"}})]),t._v(" "),s("h3",{attrs:{id:"-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#-3"}},[t._v("#")])]),t._v(" "),s("h3",{attrs:{id:"彩蛋"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#彩蛋"}},[t._v("#")]),t._v(" 彩蛋")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/424608/1583990819638-48a611e9-d1b1-43c4-a58c-9b81d416db90.png#align=left&display=inline&height=423&name=image.png&originHeight=1576&originWidth=2780&size=320566&status=done&style=shadow&width=746",alt:"image.png"}})]),t._v(" "),s("base-title",{scopedSlots:t._u([{key:"title",fn:function(){return[s("zr-title",{attrs:{title:"完整 yml 分享"}})]},proxy:!0}])}),t._v(" "),s("ul",[s("li",[t._v(".gitlab-1ci.yml")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("image: node\n\nstages:\n  - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n  - build\n  - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("zip")]),t._v("\n  - deploy\n\ncache:\n    paths:\n        - node_modules/\n        - static/\n        - front-end-caiwu.tar\n\nbefore_script:\n  - "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y ) '")]),t._v("\n  - "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("eval")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("ssh-agent -s"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n  - ssh-add "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SSH_PRIVATE_KEY_DEV")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p ~/.ssh\n  - "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[[ -f /.dockerenv ]] && echo -e \"Host *"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[t._v("\\t")]),t._v("StrictHostKeyChecking no"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("\" > ~/.ssh/config '")]),t._v("\n\ninstall:\n  stage: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n  tags:\n    - tagtym\n  only:\n    - master\n  script:\n    - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -g cnpm --registry"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://registry.npm.taobao.org\n    - cnpm "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n\nbuild:\n  stage: build\n  tags:\n    - tagtym\n  only:\n    - master\n  script:\n    - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n\nzip:\n  stage: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("zip")]),t._v("\n  tags:\n    - tagtym\n  only:\n    - master\n  script:\n   - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -czvf front-end-caiwu.tar ./static\n\ndeploy:\n  stage: deploy\n  tags:\n    - tagtym\n  only:\n    - master\n  script:\n   - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" ./front-end-caiwu.tar root@"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEPLOY_SERVER_DEV")]),t._v(":/data/frontEnd\n   - "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" root@"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEPLOY_SERVER_DEV")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cd /data/www/lighttpd/caiwu/public && rm -rf ./static/* && tar zxvf /data/frontEnd/front-end-caiwu.tar -C /data/www/lighttpd/caiwu/public && '),s("span",{pre:!0,attrs:{class:"token entity",title:"\\c"}},[t._v("\\c")]),t._v('p ./static/index.html ../resources/views/welcome.blade.php"')]),t._v("\n")])])]),s("h3",{attrs:{id:"坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#坑"}},[t._v("#")]),t._v(" 坑")]),t._v(" "),s("ul",[s("li",[t._v("npm run build 在 mac 本机打包没问题，node 环境打包就有问题，原因：import 文件名字大小有误")]),t._v(" "),s("li",[t._v("ssh 配置一直让输入密码，之前  $SSH_PRIVATE_KEY_DEV value 是从服务器上面 取的id_rsa,最后看底部博客随便找服务器，配置一个新的，然后就可以了。")]),t._v(" "),s("li",[t._v("autodevops 可以设置关闭")])]),t._v(" "),s("h3",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.cnblogs.com/xishuai/p/ubuntu-gitlab-ci-docker-aspnet-core-part-1.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ubuntu & GitLab CI & Docker & ASP.NET Core 2.0 自动化发布和部署（1）"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"https://www.cnblogs.com/szk5043/articles/9854712.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitLab之gitlab-ci.yml配置文件详解"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"https://www.ituring.com.cn/article/507812",target:"_blank",rel:"noopener noreferrer"}},[t._v("CICD 配置项"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"http://*****.com/help/ci/examples/README.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://[你的 git 地址].com/help/ci/examples/README.md"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("travis_ci_tutorial"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2016/07/yaml.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("yaml 语法"),s("OutboundLink")],1)])],1)}),[],!1,null,null,null);a.default=n.exports}}]);